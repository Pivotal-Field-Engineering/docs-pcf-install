---
title: Preparing to Deploy PCF on GCP
owner: Ops Manager
---

<strong><%= modified_date %></strong>
<html class="list-style-none"></html>

This guide describes the preparation steps required to install Pivotal Cloud Foundry (PCF) on Google Cloud Platform (GCP).

In addition to fulfilling the prerequisites listed in the [Installing Pivotal Cloud Foundry on GCP](./gcp.html) topic, you must create resources in GCP such as a new network, firewall rules, load balancers, and a service account before deploying PCF. Follow these procedures to prepare your GCP environment. 

The procedures in this topic prepare your environment for installing a deployment that matches the [Reference Architecture for Pivotal Cloud Foundry on GCP](../refarch/gcp/gcp_ref_arch.html). The deployment uses a [NAT-based network layout](../refarch/gcp/gcp_ref_arch.html), uses three availability zones (AZs), and is production-grade.

## <a id="create_network"></a>Step 1: Create a GCP Network with Three Subnets ##

Perform the following steps to create a VPC network with  subnets for infrastructure, Elastic Runtime, and services:

1. Log in to the [GCP Console](https://console.cloud.google.com/). 

1. In the console, navigate to the GCP project where you want to install PCF. 

1. Select **Networking**. 
1. Click **Create VPC Network**.
1. For **Name**, enter `pcf-virt-net`.
1. Under **Subnets**, create the following subnets in your region:
  <table>
    <tr>
    <th>Name</th>
    <th>IP Address Range</th>
    </tr>
    <tr>
      <td>pcf-subnet-infrastructure</td>
      <td>192.168.101.0/26</td>
    </tr>
    <tr>
      <td>pcf-subnet-ert</td>
      <td>192.168.16.0/22</td>
    </tr>
    <tr>
      <td>pcf-subnet-services-1</td>
      <td>192.168.20.0/22</td>
    </tr>
  </table>

	<p class="note"><strong>Note</strong>: Make sure you select a region with enough zones to support the availability zone needs of your deployment. For help selecting the correct region for your deployment, see the <a href="https://cloud.google.com/compute/docs/regions-zones/regions-zones">Google documentation on regions and zones</a>.</p> 

	<%= image_tag("gcp/gcp-network-create.png") %>

1. Click **Create**.

## <a id="firewall_rules"></a>Step 2: Create Firewall Rules for the Network

GCP lets you assign [tags](https://cloud.google.com/compute/docs/label-or-tag-resources#tags) to virtual machine (VM) instances and create firewall rules that apply to VMs based on their tags. This step assigns tags and firewall rules to Ops Manager components and VMs that handle incoming traffic. 

1. In the **Networking** pane, select **Firewall rules**, then **Create Firewall Rule**.
2. Create a firewall rule to allow all traffic within the network. 
	* **Name**: Enter `all-internal`.
	* **Network**: Select the `pcf-virt-net` network you created in the section above, [Create a GCP Network with Subnet](#create_network). 
  * **Target tags**: Not used for this firewall rule. This rule uses subnetwork CIDR rules instead to accommodate on-demand service brokers. These brokers deploy VMs outside of Ops Manager and do not apply VM tags.
	* **Source filter**: Choose **Subnetworks**, then select the three subnetworks you defined in the section above.
	* **Protocols and ports**: Select **Specified protocols and ports** and enter `tcp:0-65535;udp:0-65535;icmp`.
2. Create a firewall rule to allow SSH traffic from public networks.
  * **Name**: Enter `allow-ssh`.
  * **Network**: Select the `pcf-virt-net` network you created in the section above, [Create a GCP Network with Subnet](#create_network). 
  * **Target tags**: Enter `allow-ssh`.
  * **Source filter**: Select **IP ranges**.
  * **Source IP ranges**: Enter `0.0.0.0/0`.
  * **Protocols and ports**: Select **Specified protocols and ports** and enter `tcp:22`.
3. Create a firewall rule to allow HTTP traffic from public networks.
  * **Name**: Enter `allow-http`.
  * **Network**: Select the `pcf-virt-net` network you created in the section above, [Create a GCP Network with Subnet](#create_network). 
  * **Target tags**: Enter `allow-http`, `router`.
  * **Source filter**: Select **IP ranges**.
  * **Source IP ranges**: Enter `0.0.0.0/0`.
  * **Protocols and ports**: Select **Specified protocols and ports** and enter `tcp:80`.
3. Create a firewall rule to allow HTTPS traffic from public networks.
  * **Name**: Enter `allow-https`.
  * **Network**: Select the `pcf-virt-net` network you created in the section above, [Create a GCP Network with Subnet](#create_network). 
  * **Target tags**: Enter `allow-https`, `router`.
  * **Source filter**: Select **IP ranges**.
  * **Source IP ranges**: Enter `0.0.0.0/0`.
  * **Protocols and ports**: Select **Specified protocols and ports** and enter `tcp:443`.
3. Create a firewall rule to allow router health checks.
  * **Name**: Enter `allow-http-8080`.
  * **Network**: Select the `pcf-virt-net` network you created in the section above, [Create a GCP Network with Subnet](#create_network). 
  * **Target tags**: Enter `router`.
  * **Source filter**: Select **IP ranges**.
  * **Source IP ranges**: Enter `0.0.0.0/0`.
  * **Protocols and ports**: Select **Specified protocols and ports** and enter `tcp:8080`.
3. Create a firewall rule to allow communication among Elastic Runtime jobs.
  * **Name**: Enter `allow-ert-all`.
  * **Network**: Select the `pcf-virt-net` network you created in the section above, [Create a GCP Network with Subnet](#create_network). 
  * **Target tags**: Enter `opsman`, `nat-traverse`.
  * **Source filter**: Select **Source tags**.
  * **Source tags**: Enter `opsman`, `nat-traverse`.
  * **Protocols and ports**: Select **Specified protocols and ports** and enter `icmp; tcp; udp`.
3. Create a firewall rule to allow access to the SSH proxy.
  * **Name**: Enter `cf-ssh-proxy`.
  * **Network**: Select the `pcf-virt-net` network you created in the section above, [Create a GCP Network with Subnet](#create_network). 
  * **Target tags**: Enter `ssh-proxy`, `diego-brain`.
  * **Source filter**: Select **IP ranges**.
  * **Source IP ranges**: Enter `0.0.0.0/0`.
  * **Protocols and ports**: Select **Specified protocols and ports** and enter `tcp:2222`.
3. Create a firewall rule to allow access to the TCP router.
  * **Name**: Enter `cf-tcp`.
  * **Network**: Select the `pcf-virt-net` network you created in the section above, [Create a GCP Network with Subnet](#create_network). 
  * **Target tags**: Enter `cf-tcp`.
  * **Source filter**: Select **IP ranges**.
  * **Source IP ranges**: Enter `0.0.0.0/0`.
  * **Protocols and ports**: Select **Specified protocols and ports** and enter `tcp:1024-65535`.

## <a id="iam_account"></a>Step 3: Set up an IAM Service Account ##

1. From the GCP Console, select **IAM & Admin**, then **Service accounts**. 
1. Click **Create Service Account**: 
	* **Service account name**: Enter a name. For example, `bosh`.
	* **Role**: Select the following roles for the service account:
     <p class="note">You must scroll down in the pop-up windows to select all required roles.</p>
     * **Cloud SQL** > **Cloud SQL Admin**
     * **Compute Engine** > **Compute Instance Admin (v1)**
     * **Compute Engine** > **Compute Network Admin**
     * **Compute Engine** > **Compute Security Admin**
     * **DNS** > **DNS Administrator**
     * **Storage** > **Storage Admin**
     * **Project** > **Service Account Actor**
     <p class="note">The **Service Account Actor** role is only required if you plan to use [**The Ops Manager VM Service Account**](./gcp-om-config.html#gcp-config) to deploy Ops Manager.</p>
	* **Service account ID**: The field autogenerates a unique ID based on the username. 
	* **Furnish a new private key**: Select this checkbox and JSON as the **Key type**.
    <%= image_tag("gcp/iam_account.png") %>

1. Click **Create**. Your browser automatically downloads a JSON file with a private key for this account. Save this file in a secure location.

## <a id="keys"></a>Step 4: Create a Project-Wide SSH Keypair for Your Project ##

1. Create an SSH keypair on your local machine with the username `vcap`. For example, use the following command:
    <pre class="terminal">
    $ ssh-keygen -t rsa -f vcap-key -C vcap@local
    </pre>
    <br>
    When prompted, press enter twice to use no passphrase.

1. Open and copy the contents of the public key file `vcap-key.pub`.

1. In the GCP console, navigate to **Compute Engine > Metadata > SSH Keys**. Click **Add SSH Keys**, or **Edit** if you already have project-wide keys.

1. Paste in the contents of the `vcap-key.pub` file. The username `vcap` autopopulates the username field. 

1. Click **Save**. 

1. Verify that the public key data is uploaded to your project:
    1. If you have not done so already, install and set up [gcloud compute](https://cloud.google.com/compute/docs/gcloud-compute/). 

    1.  Execute the following command:
        <pre class="terminal">
        $ gcloud compute project-info describe
        </pre>
        The command outputs project metadata with the new key data appearing as a value in the `sshKeys` field.
        <pre class="terminal">
        commonInstanceMetadata:
        fingerprint: #######
        items:
        \- key: sshKeys
        value: |
            vcap:ssh-rsa ...
        </pre>

## <a id="enable_compute_resource_api"></a>Step 5: Enable Google Cloud APIs ##

Ops Manager manages GCP resources using the Google Compute Engine and Cloud Resource Manager APIs. To enable these APIs, perform the following steps:

1. Log in to the Google Developers console at [https://console.developers.google.com](https://console.developers.google.com).

1. In the console, navigate to the GCP project where you want to install PCF. 

1. Select **API Manager > Library**.

1. To enable an API, enter its name in the search box, click the API, and click **Enable**. Enable the following APIs:
  * Compute Engine API
  * Google Cloud Resource Manager API
  * Google Cloud Storage
  * Google Cloud SQL
  * Google Cloud DNS API

1. Select **Storage > Settings**.
1. Click **Interoperability** and click **Enable interoperability access**.
1. To verify that the APIs have been enabled, perform the following steps:
    1. Log in to GCP using the IAM service account you created in [Set up an IAM Service Account](#iam_account):
     <pre class="terminal">
     $ gcloud auth activate-service-account --key-file JSON\_KEY\_FILENAME
     </pre>

  1. List your projects:
    <pre class="terminal">
    $ gcloud projects list
    PROJECT\_ID       NAME                 PROJECT\_NUMBER
    my-project-id    my-project-name      ##############
    </pre>
    
    This command lists the projects where you enabled Google Cloud APIs.
    
## <a id="create_loadbalancers"></a>Step 6: Create Load Balancers in GCP ##

You need at least three and as many as four load balancers to operate PCF on GCP, as follows:

  * [HTTP(S) Load Balancer](#http_https_lb): For HTTP(S) load balancing, using TCP port `80` and `8080`.
  * [SSH Load Balancer](#ssh_lb): For SSH proxy jobs, using TCP port `2222`.
  * [TCP WebSockets Load Balancer](#tcp_websockets_lb): For WebSockets log tailing, using TCP port `443`.
  * [TCP Router](#tcprouter_lb): Optionally, for apps that use the TCP routing feature.

The steps required to set up each load balancer are described below.

### <a id='create-http-and-instance-group'></a>Create Instance Groups and the HTTP(S) Load Balancer ###

To configure HTTP(S) load balancing for PCF on GCP you need to follow two steps:

  1. Create one or more [**Instance Group\(s\)**](#instance_group) for load balancer configuration to the GCP **Backend service**. 
  1. Create an [HTTP(S) Load Balancer](#http_https_lb).

#### <a id="instance_group"></a> Create **Instance Group(s)** ####

You need to create and associate one or more **Instance Group(s)** with the HTTP(S) load balancer you create.

1. From the GCP Console, select **Compute Engine** and click **Instance groups**.
  <%= image_tag("gcp/create_instance_group.png") %>

1. Click **Create instance group**.

1. In the **Create a new instance group** window, name the instance group in the **Name** field. If you are creating multiple instance groups, make sure each instance group name has a unique name. For example, you might create the following instance groups:
  * `pcf-instance-group-lb-1a`
  * `pcf-instance-group-lb-1b`
  * `pcf-instance-group-lb-1c`
  <p class="note"><strong>Note</strong>: You need one Google <strong>Instance Group</strong> for each Availability Zone you plan to support. All <strong>Instance Groups</strong> must connect to the Google <strong>Backend Service</strong> to configure your load balancer, described below. For a high availability production installation of PCF, Pivotal recommends using three availability zones.</p>

1. For each individual instance group, choose **Single-zone** in the **Location** section.

1. From the **Zone** drop-down menu, select a zone that matches the **Region** of the [network](#create_network) you created above. Pick a unique zone for each instance group that you create.  For example, if you created the network in the `us-central1` region, you could pick the following zones for your instance groups:
   * `pcf-instance-group-lb-1a`:`us-central1-a` 
   * `pcf-instance-group-lb-1b`:`us-central1-b` 
   * `pcf-instance-group-lb-1c`:`us-central1-c`

1. Under **Group type**, select **Unmanaged instance group.**

1. Under **Network** and **Subnetwork**, select the network and subnet you created in the [Create a GCP Network with Subnet](#create_network) step above.
  <%= image_tag("gcp/configure_new_instance_group.png") %>
  <p class="note"><strong>Note</strong>: If <code>opsmgr</code> is your only network, the <b>Network</b> drop-down does not appear because the sole network is automatically selected.</p>

1. Click **Create**.

1. If you are creating multiple instance groups, repeat **substeps 2-7** of this procedure.

#### <a id="http_https_lb"></a> Create the HTTP(S) Load Balancer ####

To create a load balancer for HTTP(S) in GCP:

1. From the GCP Console, select **Networking > Load Balancing > Create load balancer**.

1. Under **HTTP(S) Load Balancing**, click **Start configuration**.
  <%= image_tag("gcp/http_lb_configure.png") %>

1. In the **New HTTP(S) load balancer** window, enter `pcf-router` in the **Name** field.
  <%= image_tag "gcp/http_lb_name.png" %>

1. Click **Backend configuration** to configure the **Backend service**. 

1. In the **Create or select a backend service** drop-down menu, choose **Create a backend service** to open the **Backend service** window.

1. Fill in the name for your **Backend service** in the **Name** field. Leave **Protocol** set to **HTTP**.
  <%= image_tag "gcp/backend_service_name.png" %>
1. In the **Backends** section, from the **Instance Group** drop-down menu, choose one of the [Instance Group(s)](#instance_group) you created above, and select it.

1. Add port `80` to the **Port numbers** field for PCF to make API calls.
  <%= image_tag "gcp/backend_service_config.png" %>

1. If you have created multiple instance groups to support a multiple availability zone PCF deployment, perform the following steps:
   1. Click **Add backend**.
   1. Select another instance group from the **Instance Group** drop-down menu. 
   1. Specify port `80` again if necessary. 
   1. Repeat until you have selected all the instance groups (three for three availability zones) that you created.

1. From the **Health check** drop-down menu, click to **Create a Health Check** with the following field values:
   * **Name**: Enter a name, for example `health-check`, or `pcf-public`.
   * **Description**: 
   * **Protocol**: `HTTP`
   * **Port**: `8080`
   * **Request path**: `/health`
   * Use the default <strong>Health criteria</strong> field values:
     * **Check interval**: `5` seconds
     * **Timeout**: `5` seconds
     * **Healthy threshold**: `2` consecutive successes
     * **Unhealthy threshold**: `2` consecutive failures
  <%= image_tag "gcp/health_check_defaults.png" %>
   * Click **Save and continue**. 
   The **Backend configuration** section shows a green check mark.

1. Click **Host and path rules** to populate the default fields and a green check mark.

1. Select **Frontend configuration**, and add the following:
   * **Protocol**: `HTTP`
   * **IP**: Perform the following steps:
       1. Select **Create IP address**. 
       1. Enter a **Name** for the new static IP address and an optional description. For example, `pcf-router-ip`.
       1. Under **IP**, make sure this new static IP address is selected.
       1. Click **Reserve**.
   * **Port**: `80`
1. If you are using a trusted SSL certificate or already have a self-signed certificate, proceed to step 15. 

1. If you want to use a self-signed certificate generated during [Elastic Runtime network configuration](gcp-er-config.html#networking), skip over the next step of adding the HTTPS frontend configuration until after you generate the certificate in Elastic Runtime. After you generate the certificate, return to step 15 using the following guidelines: 
   * Copy and paste the generated contents of the **Router SSL Termination Certificate and Private Key** fields from Elastic Runtime into the public certificate and private key fields. 
   * Since you are using a self-signed certificate, do not enter a value in the **Certificate Chain** field. 

1. Click **Add frontend IP and port**, and add the following:
   * **Protocol**: `HTTPS`
   * **IP**: Select the static IP address you just created for the previous rule.
   * **Port**: Leave `443` selected.
   * **Certificate**: Select **Create a new certificate**. In the next dialog, perform the following steps:
     * In the **Name** field, enter a name for the certificate.
     <%= image_tag "gcp/lb_frontend_cert.png" %>
     * In the **Public key certificate** field, copy in the contents of your public certificate, or upload your certificate as a .pem file.
     * In the **Certificate chain** field, enter or upload your certificate chain in the .pem format. If you are using a self-signed certificate, you do not need to populate this field.
     * In the **Private key** field, copy in the contents or upload the .pem file of the private key for the certificate.
1. Review the completed frontend configuration. 
    <%= image_tag "gcp/lb_frontend_config.png" %>

1. Click **Review and finalize** to verify your configuration.
  <%= image_tag "gcp/http_lb_finalize.png" %>

1. Click **Create**.

### <a id="tcp_websockets_lb"></a> Create the TCP WebSockets Load Balancer

The load balancer for tailing logs with WebSockets for PCF on GCP operates on TCP port `443`. 

1. From the GCP Console, select **Networking > Load Balancing > Create load balancer**.

1. Under **TCP Load Balancing**, click **Start configuration**.
  <%= image_tag("gcp/create_new_lb.png") %>

1. Under **Internet facing or internal only**, select **From Internet to my VMs**. Under **Connection termination**, select **No (TCP)**. 

1. Click **Continue**. 
  <%= image_tag("gcp/lb_connection_termination.png") %>

1. In the **New TCP load balancer** window, enter `pcf-websockets` in the **Name** field.

1. Click **Backend configuration** to configure the **Backend service**: 
  <%= image_tag "gcp/tcp_websockets_backend.png" %>
  * **Region**: Select the region you used to create the network in [Create a GCP Network with Subnet](#create_network).
  * From the **Health check** drop-down menu, select the [**Health check**](#http_https_lb) that you created above.
  The **Backend configuration** section shows a green check mark.

1. Click **Frontend configuration** to open its configuration window and complete the fields:
 * **Protocol**: `TCP`
 * **IP**: Perform the following steps:
       1. Select **Create IP address**. 
       1. Enter a **Name** for the new static IP address and an optional description. For example, `pcf-websockets-ip`.
       1. Click **Reserve**.
 * **Port**: `443` 
   <%= image_tag "gcp/tcp_websockets_frontend.png" %>
1. Click **Review and finalize** to verify your configuration.
  <%= image_tag "gcp/websockets_lb_finalize.png" %>
1. Click **Create**.

### <a id="ssh_lb"></a> Create the SSH Proxy Load Balancer

1. From the GCP Console, select **Networking > Load Balancing > Create load balancer**.

1. Under **TCP Load Balancing**, click **Start configuration**.
  <%= image_tag("gcp/lb-configure.png") %>

1. Under **Internet facing or internal only**, select **From Internet to my VMs**.

1. Under **Connection termination**, select **No (TCP)**. 
  <%= image_tag("gcp/lb_connection_termination.png") %>

1. Click **Continue**. 

1. In the **New TCP load balancer** window, enter `pcf-ssh` in the **Name** field.
  <%= image_tag "gcp/ssl_backend_lb_configuration.png" %>

1. Select **Backend configuration**, and enter the following field values:
   * **Region**: Select the region you used to create the network in [Create a GCP Network with Subnet](#create_network).
   * **Backup pool**: `None`
   * **Failover ratio**: `10%`
   * **Health check**: `No health check`
<%= image_tag("gcp/ssl_lb_backend_config_complete.png") %>

1. Select **Frontend configuration**, and add the following:
   * **Protocol**: `TCP`
   * **IP**: Select the IP address that you created in [Create the TCP WebSockets Load Balancer](#tcp_websockets_lb).
   * **Port**: `2222`

1. Optionally, review and finalize your load balancer. 

1. Click **Create**.

### <a id="tcprouter_lb"></a>(Optional) Create the Load Balancer for TCP Router

<p class="note"><strong>Note</strong>: This step is optional and only required if you enable TCP routing in your deployment.</p>

To create a load balancer for TCP routing in GCP, perform the following steps:

1. From the GCP Console, select **Networking > Load Balancing > Create load balancer**.

1. Under **TCP Load Balancing**, click **Start configuration**.

	<%= image_tag("gcp/lb-configure.png") %>

1. Under **Connection termination**, select **No (TCP)**. Click **Continue**. 

	<%= image_tag("gcp/lb_connection_termination.png") %>

1. On the **New TCP load balancer** screen, enter a unique name for the load balancer in the **Name** field. For example, `pcf-tcp-router`.

1. Select **Backend configuration**, and enter the following field values:
   * **Region**: Select the region you used to create the network in [Create a GCP Network with Subnet](#create_network).
   * **Health check**: Select the health check for your TCP router. Create a new health check for the TCP router on port `80` in the **Health checks** pane if you do not already have one.
        * Click **Save and continue**.
 <%= image_tag("gcp/tcp_lb_backend.png") %>

1. Select **Frontend configuration**, and add the frontend IP and port entry as follows:
   * **Protocol**: `TCP`
   * **IP**: Perform the following steps:
       1. Select **Create IP address**. 
       1. Enter a **Name** for the new static IP address and an optional description. For example, `pcf-tcp-router-ip`.
       1. Click **Reserve**.
   * **Port**: `1024-65535`

	<%= image_tag("gcp/tcp_lb_frontend.png") %>

1. Click **Review and finalize** to verify your configuration.

1. Click **Create**.

## <a id="next"></a> What to Do Next ###

* (Optional) To save time during the final stage of the installation process, you can start downloading the Elastic Runtime tile. See [Step 1: Download the Elastic Runtime Tile](./gcp-er-config.html#download-er) of the _Deploying Elastic Runtime on GCP_ topic.

* Proceed to the next step in the deployment, [Launching an Ops Manager Director Instance on GCP](./gcp-om-deploy.html). 

